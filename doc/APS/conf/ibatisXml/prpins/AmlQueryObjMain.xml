<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<!-- 
mantis：OTH0065，處理人員：BJ085，需求單編號：OTH0065 建置AML洗錢查詢畫面 start
-->
<sqlMap namespace="AmlQueryObjMain">

	<resultMap id="BaseResultMap" class="com.tlg.prpins.entity.AmlQueryObjMain" >
	    <result column="OID" property="oid" jdbcType="DECIMAL" />
	    <result column="BUSINESS_NO" property="businessNo" jdbcType="VARCHAR" />
	    <result column="EXTRA_BUSINESS_NO" property="extraBusinessNo" jdbcType="VARCHAR" />
	    <result column="APP_CODE" property="appCode" jdbcType="VARCHAR" />
	    <result column="USER_ID" property="userId" jdbcType="VARCHAR" />
	    <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
	    <result column="TYPE" property="type" jdbcType="VARCHAR" />
	    <result column="CLASS_CODE" property="classCode" jdbcType="VARCHAR" />
	    <result column="RISK_CODE" property="riskCode" jdbcType="VARCHAR"/>
	    <result column="COM_CODE" property="comCode" jdbcType="VARCHAR" />
	    <result column="CHANNEL_TYPE" property="channelType" jdbcType="VARCHAR" />
	    <result column="COM_LEVEL" property="comLevel" jdbcType="VARCHAR" />
	    <result column="PREM" property="prem" jdbcType="VARCHAR" />
	    <result column="CREATETIME" property="createtime" jdbcType="TIMESTAMP"/>
	    <result column="AML_UNI_KEY" jdbcType="VARCHAR" property="amlUniKey" />
	    <result column="RESEND" jdbcType="VARCHAR" property="resend" />
	</resultMap>

	<select id="select" resultMap="BaseResultMap" parameterClass="java.util.Map">
		<include refid="Utils.sql1" />
		SELECT * FROM <include refid="Utils.prpinsSchema"/>AML_QUERY_OBJ_MAIN
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="oid">
				OID = #oid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="businessNo">
				BUSINESS_NO = #businessNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="extraBusinessNo">
				EXTRA_BUSINESS_NO = #extraBusinessNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="appCode">
				APP_CODE = #appCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="type">
				TYPE = #type#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="classCode">
				CLASS_CODE = #classCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="riskCode">
				RISK_CODE = #riskCode#
			</isNotEmpty>
			<!-- mantis：OTH0087，處理人員：BJ085，需求單編號：OTH0087 AML手動登錄  -->
			<isNotEmpty prepend="AND" property="userId">
				USER_ID = #userId#
			</isNotEmpty>
		</dynamic>
		<include refid="Utils.sql2" />
	</select>

	<select id="selectByParams" resultMap="BaseResultMap" parameterClass="java.util.Map">
		SELECT * FROM <include refid="Utils.prpinsSchema"/>AML_QUERY_OBJ_MAIN
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="oid">
				OID = #oid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="businessNo">
				BUSINESS_NO = #businessNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="extraBusinessNo">
				EXTRA_BUSINESS_NO = #extraBusinessNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="appCode">
				APP_CODE = #appCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="type">
				TYPE = #type#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="classCode">
				CLASS_CODE = #classCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="riskCode">
				RISK_CODE = #riskCode#
			</isNotEmpty>
			<!-- mantis：OTH0087，處理人員：BJ085，需求單編號：OTH0087 AML手動登錄  -->
			<isNotEmpty prepend="AND" property="userId">
				USER_ID = #userId#
			</isNotEmpty>
		</dynamic>
	</select>
 	
	<select id="count" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(*) FROM <include refid="Utils.prpinsSchema"/>AML_QUERY_OBJ_MAIN
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="oid">
				OID = #oid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="businessNo">
				BUSINESS_NO = #businessNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="extraBusinessNo">
				EXTRA_BUSINESS_NO = #extraBusinessNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="appCode">
				APP_CODE = #appCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="type">
				TYPE = #type#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="classCode">
				CLASS_CODE = #classCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="riskCode">
				RISK_CODE = #riskCode#
			</isNotEmpty>
			<!-- mantis：OTH0087，處理人員：BJ085，需求單編號：OTH0087 AML手動登錄  -->
			<isNotEmpty prepend="AND" property="userId">
				USER_ID = #userId#
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="selectMaxOid" resultMap="BaseResultMap" parameterClass="java.util.Map">	
		<include refid="Utils.sql1" />
		SELECT * <include refid="Utils.prpinsSchema"/> FROM (
			SELECT BUSINESS_NO, MAX(OID) as OID
	      	FROM aml_query_obj_main
	      	GROUP BY BUSINESS_NO) B
	    INNER JOIN AML_QUERY_OBJ_MAIN A
	    ON A.BUSINESS_NO=B.BUSINESS_NO AND A.OID=B.OID
	    <dynamic prepend="WHERE">
	    	<isNotEmpty prepend="AND" property="userId">
				A.USER_ID = #userId#
			</isNotEmpty>
	    	<isNotEmpty prepend="AND" property="businessNo">
				A.BUSINESS_NO = #businessNo#
			</isNotEmpty>
	    	<isNotEmpty prepend="AND" property="classCode">
				A.CLASS_CODE = #classCode#
			</isNotEmpty>
	    	<isNotEmpty prepend="AND" property="riskCode">
				A.RISK_CODE = #riskCode#
			</isNotEmpty>
    	</dynamic>
    	<include refid="Utils.sql2" />
	</select>
	
	<select id="countMaxOid" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(*) <include refid="Utils.prpinsSchema"/> FROM (
			SELECT BUSINESS_NO, MAX(OID) as OID
	      	FROM aml_query_obj_main
	      	GROUP BY BUSINESS_NO) B
	    INNER JOIN AML_QUERY_OBJ_MAIN A
	    ON A.BUSINESS_NO=B.BUSINESS_NO AND A.OID=B.OID
	    <dynamic prepend="WHERE">
	    	<isNotEmpty prepend="AND" property="userId">
				A.USER_ID = #userId#
			</isNotEmpty>
	    	<isNotEmpty prepend="AND" property="businessNo">
				A.BUSINESS_NO = #businessNo#
			</isNotEmpty>
	    	<isNotEmpty prepend="AND" property="classCode">
				A.CLASS_CODE = #classCode#
			</isNotEmpty>
	    	<isNotEmpty prepend="AND" property="riskCode">
				A.RISK_CODE = #riskCode#
			</isNotEmpty>
    	</dynamic>
	</select>

	<insert id="insert" parameterClass="com.tlg.prpins.entity.AmlQueryObjMain" >

		<selectKey resultClass="java.math.BigDecimal" keyProperty="oid" >    
	       SELECT AML_QUERY_OBJ_MAIN_SEQ.NEXTVAL AS OID FROM DUAL    
	    </selectKey>
     	
		INSERT INTO <include refid="Utils.prpinsSchema"/>AML_QUERY_OBJ_MAIN (OID, BUSINESS_NO, EXTRA_BUSINESS_NO, APP_CODE, USER_ID, USER_NAME, TYPE,
      	CLASS_CODE, COM_CODE, CHANNEL_TYPE, COM_LEVEL, PREM, CREATETIME, RISK_CODE, AML_UNI_KEY, RESEND)
    	values (#oid:DECIMAL#, #businessNo:VARCHAR#, #extraBusinessNo:VARCHAR#, #appCode:VARCHAR#, #userId:VARCHAR#,
      	#userName:VARCHAR#, #type:VARCHAR#, #classCode:VARCHAR#, #comCode:VARCHAR#,
      	#channelType:VARCHAR#, #comLevel:VARCHAR#, #prem:VARCHAR#, #createtime:TIMESTAMP#,
      	#riskCode:VARCHAR#, #amlUniKey:VARCHAR#, #resend:VARCHAR#)
      	
	</insert>


</sqlMap>