<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- mantis：FIR0565，處理人員：CC009，需求單編號：FIR0565 住火_複保險通知轉檔作業 -->
<sqlMap namespace="FirRepeatpolicyBatchDtl">
  <resultMap class="com.tlg.prpins.entity.FirRepeatpolicyBatchDtl" id="BaseResultMap">
    <result column="BATCH_NO" jdbcType="VARCHAR" property="batchNo" />
    <result column="POLICYNO" jdbcType="VARCHAR" property="policyno" />
    <result column="IS_ENDOR" jdbcType="VARCHAR" property="isEndor" />
    <result column="APPLY_NAME" jdbcType="VARCHAR" property="applyName" />
    <result column="INSURED_NAME" jdbcType="VARCHAR" property="insuredName" />
    <result column="INSURED_ID" jdbcType="VARCHAR" property="insuredId" />
    <result column="APPLY_POSTCODE" jdbcType="VARCHAR" property="applyPostcode" />
    <result column="APPLY_ADDRESS" jdbcType="VARCHAR" property="applyAddress" />
    <result column="ADDRESS_CODE" jdbcType="VARCHAR" property="addressCode" />
    <result column="ADDRESSDETAILINFO" jdbcType="VARCHAR" property="addressdetailinfo" />
    <result column="MORTGAGEEPEOPLE" jdbcType="VARCHAR" property="mortgageepeople" />
    <result column="LOANSDEPARTMENT" jdbcType="VARCHAR" property="loansdepartment" />
    <result column="STARTDATE" jdbcType="TIMESTAMP" property="startdate" />
    <result column="ENDDATE" jdbcType="TIMESTAMP" property="enddate" />
    <result column="REPEAT_COMPANY" jdbcType="VARCHAR" property="repeatCompany" />
    <result column="REPEAT_POLICYNO" jdbcType="VARCHAR" property="repeatPolicyno" />
    <result column="REPEAT_SDATE" jdbcType="TIMESTAMP" property="repeatSdate" />
    <result column="REPEAT_EDATE" jdbcType="TIMESTAMP" property="repeatEdate" />
    <result column="CONTACT_NUMBER" jdbcType="VARCHAR" property="contactNumber" />
    <result column="ICREATE" jdbcType="VARCHAR" property="icreate" />
    <result column="DCREATE" jdbcType="TIMESTAMP" property="dcreate" />
  </resultMap>
  
  <resultMap class="com.tlg.aps.vo.Aps042ImportVo" id="aps042ImportVoResultMap">
  	<result column="IS_ENDOR" jdbcType="VARCHAR" property="isEndor" />
  	<result column="APPLY_NAME" jdbcType="VARCHAR" property="applyName" />
    <result column="INSURED_NAME" jdbcType="VARCHAR" property="insuredName" />
    <result column="INSURED_ID" jdbcType="VARCHAR" property="insuredId" />
    <result column="APPLY_POSTCODE" jdbcType="VARCHAR" property="applyPostcode" />
    <result column="APPLY_ADDRESS" jdbcType="VARCHAR" property="applyAddress" />
    <result column="ADDRESS_CODE" jdbcType="VARCHAR" property="addressCode" />
    <result column="ADDRESSDETAILINFO" jdbcType="VARCHAR" property="addressdetailinfo" />
    <result column="MORTGAGEEPEOPLE" jdbcType="VARCHAR" property="mortgageepeople" />
    <result column="LOANSDEPARTMENT" jdbcType="VARCHAR" property="loansdepartment" />
    <result column="CONTACT_NUMBER" jdbcType="VARCHAR" property="contactNumber" />
    <result column="STARTDATE" jdbcType="TIMESTAMP" property="startdate" />
    <result column="ENDDATE" jdbcType="TIMESTAMP" property="enddate" />
  </resultMap>
  
  <select id="selectByParams" resultMap="BaseResultMap" parameterClass="java.util.Map">
		SELECT * FROM FIR_REPEATPOLICY_BATCH_DTL
		<dynamic prepend="WHERE">
		  <isNotNull prepend="AND" property="batchNo">
	        BATCH_NO = #batchNo:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="policyno">
	        POLICYNO = #policyno:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="isEndor">
	        IS_ENDOR = #isEndor:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="applyName">
	        APPLY_NAME = #applyName:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="insuredName">
	        INSURED_NAME = #insuredName:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="insuredId">
	        INSURED_ID = #insuredId:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="applyPostcode">
	        APPLY_POSTCODE = #applyPostcode:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="applyAddress">
	        APPLY_ADDRESS = #applyAddress:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="addressCode">
	        ADDRESS_CODE = #addressCode:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="addressdetailinfo">
	        ADDRESSDETAILINFO = #addressdetailinfo:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="mortgageepeople">
	        MORTGAGEEPEOPLE = #mortgageepeople:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="loansdepartment">
	        LOANSDEPARTMENT = #loansdepartment:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="startdate">
	        STARTDATE = #startdate:TIMESTAMP#
	      </isNotNull>
	      <isNotNull prepend="AND" property="enddate">
	        ENDDATE = #enddate:TIMESTAMP#
	      </isNotNull>
	      <isNotNull prepend="AND" property="repeatCompany">
	        REPEAT_COMPANY = #repeatCompany:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="repeatPolicyno">
	        REPEAT_POLICYNO = #repeatPolicyno:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="repeatSdate">
	        REPEAT_SDATE = #repeatSdate:TIMESTAMP#
	      </isNotNull>
	      <isNotNull prepend="AND" property="repeatEdate">
	        REPEAT_EDATE = #repeatEdate:TIMESTAMP#
	      </isNotNull>
	      <isNotNull prepend="AND" property="contactNumber">
	        CONTACT_NUMBER = #contactNumber:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="icreate">
	        ICREATE = #icreate:VARCHAR#
	      </isNotNull>
	      <isNotNull prepend="AND" property="dcreate">
	        DCREATE = #dcreate:TIMESTAMP#
	      </isNotNull>
		</dynamic>
	      <isNotNull prepend="" property="sortBy">
	        ORDER BY  $sortBy$
	      </isNotNull>
	</select>
  
  <select id="select" parameterClass="java.util.Map" resultMap="BaseResultMap">
  	<include refid="Utils.sql1" />
    select *
    from FIR_REPEATPOLICY_BATCH_DTL 
    <dynamic prepend="WHERE">
      <isNotNull prepend="AND" property="batchNo">
	    BATCH_NO = #batchNo:VARCHAR#
	  </isNotNull>
	  <isNotNull prepend="AND" property="policyno">
	    POLICYNO = #policyno:VARCHAR#
	  </isNotNull>
      <isNotNull prepend="AND" property="isEndor">
        IS_ENDOR = #isEndor:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="applyName">
        APPLY_NAME = #applyName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="insuredName">
        INSURED_NAME = #insuredName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="insuredId">
        INSURED_ID = #insuredId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="applyPostcode">
        APPLY_POSTCODE = #applyPostcode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="applyAddress">
        APPLY_ADDRESS = #applyAddress:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="addressCode">
        ADDRESS_CODE = #addressCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="addressdetailinfo">
        ADDRESSDETAILINFO = #addressdetailinfo:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="mortgageepeople">
        MORTGAGEEPEOPLE = #mortgageepeople:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="loansdepartment">
        LOANSDEPARTMENT = #loansdepartment:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="startdate">
        STARTDATE = #startdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="enddate">
        ENDDATE = #enddate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatCompany">
        REPEAT_COMPANY = #repeatCompany:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatPolicyno">
        REPEAT_POLICYNO = #repeatPolicyno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatSdate">
        REPEAT_SDATE = #repeatSdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatEdate">
        REPEAT_EDATE = #repeatEdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="contactNumber">
        CONTACT_NUMBER = #contactNumber:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="icreate">
        ICREATE = #icreate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="dcreate">
        DCREATE = #dcreate:TIMESTAMP#
      </isNotNull>
    </dynamic>
    <include refid="Utils.sql2" />
  </select>
  
  <select id="selectByUK" parameterClass="java.util.Map" resultMap="BaseResultMap">
    select *
    from FIR_REPEATPOLICY_BATCH_DTL
    where BATCH_NO = #batchNo:VARCHAR#
      and POLICYNO = #policyno:VARCHAR#
  </select>
  
  <delete id="deleteByEntity" parameterClass="com.tlg.prpins.entity.FirRepeatpolicyBatchDtl">
    delete from FIR_REPEATPOLICY_BATCH_DTL
    where BATCH_NO = #batchNo:VARCHAR#
      and POLICYNO = #policyno:VARCHAR#
  </delete>
  
  <insert id="insert" parameterClass="com.tlg.prpins.entity.FirRepeatpolicyBatchDtl">
    insert into FIR_REPEATPOLICY_BATCH_DTL (BATCH_NO, POLICYNO, IS_ENDOR, 
      APPLY_NAME, INSURED_NAME, INSURED_ID, APPLY_POSTCODE, 
      APPLY_ADDRESS, ADDRESS_CODE, ADDRESSDETAILINFO, MORTGAGEEPEOPLE, 
      LOANSDEPARTMENT, STARTDATE, ENDDATE, REPEAT_COMPANY, 
      REPEAT_POLICYNO, REPEAT_SDATE, REPEAT_EDATE, CONTACT_NUMBER, 
      ICREATE, DCREATE)
    values (#batchNo:VARCHAR#, #policyno:VARCHAR#, #isEndor:VARCHAR#, 
      #applyName:VARCHAR#, #insuredName:VARCHAR#, #insuredId:VARCHAR#, #applyPostcode:VARCHAR#, 
      #applyAddress:VARCHAR#, #addressCode:VARCHAR#, #addressdetailinfo:VARCHAR#, #mortgageepeople:VARCHAR#, 
      #loansdepartment:VARCHAR#, #startdate:TIMESTAMP#, #enddate:TIMESTAMP#, #repeatCompany:VARCHAR#, 
      #repeatPolicyno:VARCHAR#, #repeatSdate:TIMESTAMP#, #repeatEdate:TIMESTAMP#, #contactNumber:VARCHAR#, 
      #icreate:VARCHAR#, #dcreate:TIMESTAMP#)
  </insert>
  
  <select id="count" parameterClass="java.util.Map" resultClass="java.lang.Integer">
    select count(*) from FIR_REPEATPOLICY_BATCH_DTL
    <dynamic prepend="WHERE">
      <isNotNull prepend="AND" property="batchNo">
	    BATCH_NO = #batchNo:VARCHAR#
	  </isNotNull>
	  <isNotNull prepend="AND" property="policyno">
	    POLICYNO = #policyno:VARCHAR#
	  </isNotNull>
      <isNotNull prepend="AND" property="isEndor">
        IS_ENDOR = #isEndor:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="applyName">
        APPLY_NAME = #applyName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="insuredName">
        INSURED_NAME = #insuredName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="insuredId">
        INSURED_ID = #insuredId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="applyPostcode">
        APPLY_POSTCODE = #applyPostcode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="applyAddress">
        APPLY_ADDRESS = #applyAddress:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="addressCode">
        ADDRESS_CODE = #addressCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="addressdetailinfo">
        ADDRESSDETAILINFO = #addressdetailinfo:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="mortgageepeople">
        MORTGAGEEPEOPLE = #mortgageepeople:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="loansdepartment">
        LOANSDEPARTMENT = #loansdepartment:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="startdate">
        STARTDATE = #startdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="enddate">
        ENDDATE = #enddate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatCompany">
        REPEAT_COMPANY = #repeatCompany:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatPolicyno">
        REPEAT_POLICYNO = #repeatPolicyno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatSdate">
        REPEAT_SDATE = #repeatSdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="repeatEdate">
        REPEAT_EDATE = #repeatEdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="AND" property="contactNumber">
        CONTACT_NUMBER = #contactNumber:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="icreate">
        ICREATE = #icreate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="AND" property="dcreate">
        DCREATE = #dcreate:TIMESTAMP#
      </isNotNull>
    </dynamic>
  </select>
  
  <update id="update" parameterClass="com.tlg.prpins.entity.FirRepeatpolicyBatchDtl">
    update FIR_REPEATPOLICY_BATCH_DTL
    <dynamic prepend="set">
      <isNotNull prepend="," property="isEndor">
        IS_ENDOR = #isEndor:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="applyName">
        APPLY_NAME = #applyName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="insuredName">
        INSURED_NAME = #insuredName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="insuredId">
        INSURED_ID = #insuredId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="applyPostcode">
        APPLY_POSTCODE = #applyPostcode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="applyAddress">
        APPLY_ADDRESS = #applyAddress:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="addressCode">
        ADDRESS_CODE = #addressCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="addressdetailinfo">
        ADDRESSDETAILINFO = #addressdetailinfo:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="mortgageepeople">
        MORTGAGEEPEOPLE = #mortgageepeople:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="loansdepartment">
        LOANSDEPARTMENT = #loansdepartment:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="startdate">
        STARTDATE = #startdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="enddate">
        ENDDATE = #enddate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="repeatCompany">
        REPEAT_COMPANY = #repeatCompany:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="repeatPolicyno">
        REPEAT_POLICYNO = #repeatPolicyno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="repeatSdate">
        REPEAT_SDATE = #repeatSdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="repeatEdate">
        REPEAT_EDATE = #repeatEdate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="contactNumber">
        CONTACT_NUMBER = #contactNumber:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="icreate">
        ICREATE = #icreate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="dcreate">
        DCREATE = #dcreate:TIMESTAMP#
      </isNotNull>
    </dynamic>
    where BATCH_NO = #batchNo:VARCHAR#
      and POLICYNO = #policyno:VARCHAR#
  </update>
  
  <select id="selectForAps042Import" resultMap="aps042ImportVoResultMap" parameterClass="java.util.Map">
  	SELECT
      (CASE WHEN AA.ENDORSETIMES <![CDATA[>]]> 0 THEN 'Y' WHEN PP.ENDORTYPE IN ('98','21', '19') THEN 'C' ELSE 'N' END ) AS IS_ENDOR,
      DD.INSUREDNAME AS APPLY_NAME,(CASE WHEN LENGTH(TRIM(EE.INSUREDNAME) ) <![CDATA[<=]]> 3   THEN REPLACE(EE.INSUREDNAME,SUBSTR(EE.INSUREDNAME,2,1),'*')
        ELSE REPLACE(EE.INSUREDNAME,SUBSTR(EE.INSUREDNAME,2,LENGTH(TRIM(EE.INSUREDNAME) ) - 2),'**') END ) AS INSURED_NAME,
      EE.IDENTIFYNUMBER AS INSURED_ID,
      SUBSTR(SUBSTR(DD.POSTCODE,1,3),1,3) AS APPLY_POSTCODE,
      DD.POSTADDRESS AS APPLY_ADDRESS, FF.ADDRESSCODE AS ADDRESS_CODE,
      (CASE
          WHEN INSTR(FF.ADDRESSDETAILINFO,'鄉') > 0 THEN ( REPLACE(FF.ADDRESSDETAILINFO,SUBSTR(FF.ADDRESSDETAILINFO,INSTR(FF.ADDRESSDETAILINFO,'鄉') + 1),'*****'))
          WHEN INSTR(FF.ADDRESSDETAILINFO,'鎮') > 0 THEN ( REPLACE(FF.ADDRESSDETAILINFO,SUBSTR(FF.ADDRESSDETAILINFO,INSTR(FF.ADDRESSDETAILINFO,'鎮') + 1),'*****'))
          WHEN INSTR(FF.ADDRESSDETAILINFO,'區') > 0 THEN ( REPLACE(FF.ADDRESSDETAILINFO,SUBSTR(FF.ADDRESSDETAILINFO,INSTR(FF.ADDRESSDETAILINFO,'區') + 1),'*****'))
          WHEN INSTR(FF.ADDRESSDETAILINFO,'市') > 0 THEN ( REPLACE(FF.ADDRESSDETAILINFO,SUBSTR(FF.ADDRESSDETAILINFO,INSTR(FF.ADDRESSDETAILINFO,'市') + 1),'*****'))
          ELSE FF.ADDRESSDETAILINFO
      END) AS ADDRESSDETAILINFO,
      CC.MORTGAGEEPEOPLE AS MORTGAGEEPEOPLE,
      (CASE WHEN AA.BUSINESSNATURE = 'I99050' THEN BB.LOANSDEPARTMENT ELSE '' END) AS LOANSDEPARTMENT,
      AA.STARTDATE AS STARTDATE, AA.ENDDATE AS ENDDATE,
      (CASE WHEN AA.BUSINESSNATURE = 'I99050' THEN '0800-212192' ELSE '0800-075777' END) AS CONTACT_NUMBER
	FROM PRPCMAIN AA
	LEFT JOIN PRPPHEAD PP ON PP.POLICYNO = AA.POLICYNO
	LEFT JOIN PRPCMORTGAGEE BB ON AA.POLICYNO = BB.POLICYNO
	LEFT JOIN PRPCMORTGAGEECI CC ON AA.POLICYNO = CC.POLICYNO
	LEFT JOIN PRPCINSURED DD ON AA.POLICYNO = DD.POLICYNO AND DD.INSUREDFLAG = '2'
	LEFT JOIN PRPCINSURED EE ON AA.POLICYNO = EE.POLICYNO AND EE.INSUREDFLAG = '1'
	LEFT JOIN PRPCADDRESS FF ON AA.POLICYNO = FF.POLICYNO
	WHERE AA.POLICYNO = #policyno:VARCHAR# AND ROWNUM = 1
	ORDER BY DD.SERIALNO, EE.SERIALNO
  </select>
</sqlMap>