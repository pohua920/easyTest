<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TerminationNotice">
  <resultMap class="com.tlg.msSqlMob.entity.TerminationNotice" id="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 27 15:23:17 CST 2023.
    -->
    <result column="transaction_id" jdbcType="VARCHAR" property="transactionId" />
    <result column="policy_no" jdbcType="VARCHAR" property="policyNo" />
    <result column="insured_name" jdbcType="NVARCHAR" property="insuredName" />
    <result column="phone_number" jdbcType="VARCHAR" property="phoneNumber" />
    <result column="service_termination_date" jdbcType="NVARCHAR" property="serviceTerminationDate" />
    <result column="input_date" jdbcType="VARCHAR" property="inputDate" />
    <result column="serial_no" jdbcType="VARCHAR" property="serialNo" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="is_send" jdbcType="VARCHAR" property="isSend" />
    <result column="created_by" jdbcType="VARCHAR" property="createdBy" />
    <result column="created_time" jdbcType="TIMESTAMP" property="createdTime" />
    <result column="modified_by" jdbcType="VARCHAR" property="modifiedBy" />
    <result column="modified_time" jdbcType="TIMESTAMP" property="modifiedTime" />
  </resultMap>
  
  <resultMap class="com.tlg.aps.vo.mob.fetPolicy.TerminationNoticeVo" id="tnVoMap">
    <result column="policy_no" jdbcType="VARCHAR" property="policyNo" />
    <result column="insured_name" jdbcType="NVARCHAR" property="insuredName" />
    <result column="phone_number" jdbcType="VARCHAR" property="phoneNumber" />
    <result column="service_termination_date" jdbcType="NVARCHAR" property="serviceTerminationDate" />
    <result column="type" jdbcType="VARCHAR" property="type" />
  </resultMap>
  
  <select id="select" parameterClass="java.util.Map" resultMap="BaseResultMap">
  	<include refid="Utils.msSql1" />
    select * from TERMINATION_NOTICE
    <dynamic prepend="WHERE">
      <isNotEmpty prepend="AND" property="transactionId">
        transaction_id = #transactionId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="policyNo">
        policy_no = #policyNo:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="type">
        type = #type:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="isSend">
        is_send = #isSend:VARCHAR#
      </isNotEmpty>
    </dynamic>
    <include refid="Utils.msSql2" />
  </select>
  
  <select id="selectByParams" parameterClass="java.util.Map" resultMap="BaseResultMap">
    select * from TERMINATION_NOTICE
    <dynamic prepend="WHERE">
      <isNotEmpty prepend="AND" property="transactionId">
        transaction_id = #transactionId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="policyNo">
        policy_no = #policyNo:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="type">
        type = #type:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="isSend">
        is_send = #isSend:VARCHAR#
      </isNotEmpty>
    </dynamic>
  </select>
  
  <select id="count" resultClass="java.lang.Integer" parameterClass="java.util.Map">
    select COUNT(*) from TERMINATION_NOTICE
    <dynamic prepend="WHERE">
      <isNotEmpty prepend="AND" property="transactionId">
        transaction_id = #transactionId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="policyNo">
        policy_no = #policyNo:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="type">
        type = #type:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="isSend">
        is_send = #isSend:VARCHAR#
      </isNotEmpty>
    </dynamic>
  </select>
  
  <select id="countByUK" resultClass="java.lang.Integer" parameterClass="com.tlg.msSqlMob.entity.TerminationNotice" >
		SELECT COUNT(*) FROM TERMINATION_NOTICE
		where transaction_id = #transactionId:VARCHAR#
  </select>
  
  <select id="selectByPrimaryKey" parameterClass="com.tlg.msSqlMob.entity.TerminationNotice" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 27 15:23:17 CST 2023.
    -->
    select * 
    from TERMINATION_NOTICE
    where transaction_id = #transactionId:VARCHAR#
  </select>
  
  <delete id="deleteByEntity" parameterClass="com.tlg.msSqlMob.entity.TerminationNotice">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 27 15:23:17 CST 2023.
    -->
    delete from TERMINATION_NOTICE
    where transaction_id = #transactionId:VARCHAR#
  </delete>

  <insert id="insert" parameterClass="com.tlg.msSqlMob.entity.TerminationNotice">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 27 15:23:17 CST 2023.
    -->
    insert into TERMINATION_NOTICE (transaction_id, policy_no, insured_name, phone_number, 
      service_termination_date, input_date, serial_no, type, is_send, 
      created_by, created_time, modified_by, modified_time
      )
    values (#transactionId:VARCHAR#, #policyNo:VARCHAR#, #insuredName:NVARCHAR#, #phoneNumber:VARCHAR#, 
      #serviceTerminationDate:NVARCHAR#, #inputDate:VARCHAR#, #serialNo:VARCHAR#, #type:VARCHAR#, #isSend:VARCHAR#,
      #createdBy:VARCHAR#, #createdTime:TIMESTAMP#, #modifiedBy:VARCHAR#, #modifiedTime:TIMESTAMP#
      )
  </insert>

  <update id="update" parameterClass="com.tlg.msSqlMob.entity.TerminationNotice">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 27 15:23:17 CST 2023.
    -->
    update TERMINATION_NOTICE
    <dynamic prepend="set">
      <isNotNull prepend="," property="policyNo">
        policy_no = #policyNo:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="insuredName">
        insured_name = #insuredName:NVARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="phoneNumber">
        phone_number = #phoneNumber:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="serviceTerminationDate">
        service_termination_date = #serviceTerminationDate:NVARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="inputDate">
        input_date = #inputDate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="serialNo">
        serial_no = #serialNo:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="type">
        type = #type:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="isSend">
        is_send = #isSend:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="createdBy">
        created_by = #createdBy:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="createdTime">
        created_time = #createdTime:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="modifiedBy">
        modified_by = #modifiedBy:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="modifiedTime">
        modified_time = #modifiedTime:TIMESTAMP#
      </isNotNull>
    </dynamic>
    where transaction_id = #transactionId:VARCHAR#
  </update>
  
  <!-- 自取消 -->
  <select id="selectForCancel" parameterClass="java.util.Map" resultMap="tnVoMap">
    Select fmp.POLICY_NO , fmp.INSURED_NAME, fmp.mobile AS PHONE_NUMBER, cus.SERVICE_TERMINATION_DATE, 
    	'CANCEL' AS TYPE 
    from FET_MOBILE_POLICY fmp 
		left join CUSTOMER cus on cus.TRANSACTION_ID = fmp.TRANSACTION_ID and cus.transaction_type = 'CANCEL' 
		left join APPLICATION app on cus.transaction_id = app.transaction_id 
		left join TERMINATION_NOTICE tn on fmp.POLICY_NO = tn.POLICY_NO 
	where tn.POLICY_NO is null 
		and fmp.ENDORSE_TYPE in ('19','21') 
		and app.proposal_file_check is not null 
		and app.proposal_file_check = 'Y'
		<isNotEmpty prepend="AND" property="transactionId">
			fmp.TRANSACTION_ID = #transactionId:VARCHAR#
		</isNotEmpty>
	order by fmp.POLICY_NO;
  </select>
  
  <!-- 未繳費(中途退保) -->
  <select id="selectForUnpaid1" parameterClass="java.util.Map" resultMap="tnVoMap">
    Select fmp.POLICY_NO, fmp.INSURED_NAME, fmp.mobile AS PHONE_NUMBER, ac.Max_date AS SERVICE_TERMINATION_DATE, 
    	'UNPAID' AS TYPE 
    from FET_MOBILE_POLICY fmp 
		left join (
			SELECT AC005, MAX(AC007) AS Max_date FROM AC_FILE GROUP BY AC005
      	) AS ac on ac.ac005 = fmp.policy_no 
		left join TERMINATION_NOTICE tn on fmp.POLICY_NO = tn.POLICY_NO 
	where tn.POLICY_NO is null 
		and fmp.ENDORSE_TYPE = '21X' 
		and ac.Max_date is not null 
	order by fmp.POLICY_NO;
  </select>
  
  <!-- 未繳費(註銷) -->
  <select id="selectForUnpaid2" parameterClass="java.util.Map" resultMap="tnVoMap">
    Select fmp.POLICY_NO, fmp.INSURED_NAME, fmp.mobile AS PHONE_NUMBER, fmp.start_date AS SERVICE_TERMINATION_DATE, 
    	'UNPAID' AS TYPE 
    from FET_MOBILE_POLICY fmp 
		left join CUSTOMER_ENDORSE ce on ce.transaction_id = fmp.transaction_id and ce.endorse_type = '19X' 
		left join TERMINATION_NOTICE tn on fmp.POLICY_NO = tn.POLICY_NO 
	where tn.POLICY_NO is null 
		and ce.policy_no is not null 
	order by fmp.POLICY_NO;
  </select>
  
</sqlMap>