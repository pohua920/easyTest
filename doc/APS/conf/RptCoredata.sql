SELECT 
VARCHAR_FORMAT(TO_DATE(CHAR(ARE05+19110000),'YYYYMMDD'),'YYYY-MM-DD')AS PolDate,
ARE04 AS PolicyNo,
CASE WHEN ARE03 = '1' THEN '' ELSE 
ARE01 END  AS EndorseNo, 
case 
when 
SUBSTRING(are04,7,2) = 'FA' and p1.FEA06 in ('A','N') then 'FA'
else 
SUBSTRING(are04,7,2) end AS InType,
CASE WHEN ARE03 = '1' THEN '保單' ELSE '批改' END AS TYPE,  
(SELECT MAX(c.CMGT06) FROM TSTCOMMDAT.CMGTFIL c WHERE c.CMGT03=a.ARE04 AND c.CMGT05 = '2') AS InsuId,
(SELECT MAX(c2.CMGT04) FROM TSTCOMMDAT.CMGTFIL c2 WHERE c2.CMGT03=a.ARE04 AND c2.CMGT05 = '2') AS InsuName,
VARCHAR_FORMAT(TO_DATE(CHAR(ARE22+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EffDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(ARE22+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS StartPeriodDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(ARE24+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EndPeriodDate,
sum(ARE07) AS TotalPrem, --保費
ARE25 AS ChannelId,
(SELECT c3.CMRC02 FROM TSTCOMMDAT.CMRCFIL c3 WHERE c3.CMRC01=ARE25) AS ChannelName, 
SUBSTRING(ARE75,17,10) AS ChnlAgentBussNo,
'' AS ChnlAgentName ,
ARE34 AS PolAgentId,
(SELECT c5.CMEM01 FROM TSTCOMMDAT.CMEMFIL c5 WHERE c5.CMEM00=ARE34) AS PolAgentName

FROM TSTFLIBF.AREFIL a 
LEFT Join TSTFDATA01.LFFEA01 p1 ON  p1.FEA02 =SUBSTRING(are04,5,10) AND p1.FEA01 =SUBSTRING(are04,3,2) 
WHERE ARE05 = VARCHAR_FORMAT(CURRENT TIMESTAMP, 'YYYYMMDD')-19110001 AND ARE23 IN ('F')  
AND ARE07 <> 0   
AND ARE25 NOT IN ('Y00008','I99055','I99050')
GROUP BY ARE05,ARE01,ARE23,ARE03,ARE04,ARE22,ARE25,ARE10,ARE34,ARE75,ARE24,ARE25,FEA06
union
SELECT 
VARCHAR_FORMAT(TO_DATE(CHAR(APA17+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS PolDate,
APA07 AS PolicyNo,
APA01 AS EndorseNo,
case 
when 
SUBSTRING(APA07,7,2) = 'FA' and p1.FEA06 in ('A','N') then 'FA'
else 
SUBSTRING(APA07,7,2) end AS InType,
'批改' AS TYPE, 
(SELECT MAX(c.CMGT06) FROM TSTCOMMDAT.CMGTFIL c WHERE c.CMGT03=a2.APA07 AND c.CMGT05 = '2') AS InsuId,
(SELECT MAX(c2.CMGT04) FROM TSTCOMMDAT.CMGTFIL c2 WHERE c2.CMGT03=a2.APA07 AND c2.CMGT05 = '2') AS InsuName,
VARCHAR_FORMAT(TO_DATE(CHAR(APA56+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EffDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(APA56+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS StartPeriodDate,
VARCHAR_FORMAT(TO_DATE(CHAR(APA57+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EndPeriodDate, 
sum(APA08*-1) AS TotalPrem, 
APA20 AS ChannelId ,
(SELECT c3.CMRC02 FROM TSTCOMMDAT.CMRCFIL c3 WHERE c3.CMRC01=APA20) AS ChannelName, 
SUBSTRING(APA75,17,10) AS ChnlAgentBussNo,
'' AS ChnlAgentName ,
APA50 AS PolAgentId ,
(SELECT c5.CMEM01 FROM TSTCOMMDAT.CMEMFIL c5 WHERE c5.CMEM00=APA50) AS PolAgentName 
FROM TSTFLIBF.APAFIL a2 
LEFT Join TSTFDATA01.LFFEA01 p1 ON  p1.FEA02 =SUBSTRING(APA07,5,10) AND p1.FEA01 =SUBSTRING(APA07,3,2) 

WHERE APA17 = VARCHAR_FORMAT(CURRENT TIMESTAMP, 'YYYYMMDD')-19110001  AND APA06 IN ('2','3','4','D','E') AND APA18 IN ('F') 
AND APA20 NOT IN ('Y00008','I99055','I99050')
GROUP BY APA17,APA01,APA18,APA07,APA56,APA20,APA09,APA50,APA57,APA75,APA74,FEA06
union
SELECT 
VARCHAR_FORMAT(TO_DATE(CHAR(ARE05+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS PolDate,
ARE04 AS PolicyNo,
CASE WHEN ARE03 = '1' THEN '' ELSE 
ARE01 END  AS EndorseNo, 
SUBSTRING(are04,7,2)AS InsType,
CASE WHEN ARE03 = '1' THEN '保單' ELSE '批改' END AS TYPE, 
(SELECT MAX(c.CMGT06) FROM TSTCOMMDAT.CMGTFIL c WHERE c.CMGT03=a.ARE04 AND c.CMGT05 = '2') AS InsuId,
(SELECT MAX(c2.CMGT04) FROM TSTCOMMDAT.CMGTFIL c2 WHERE c2.CMGT03=a.ARE04 AND c2.CMGT05 = '2') AS InsuName,
VARCHAR_FORMAT(TO_DATE(CHAR(ARE22+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EffDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(ARE22+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS StartPeriodDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(ARE24+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EndPeriodDate,
sum(ARE07) AS TotalPrem, 
ARE25 AS ChannelId,
(SELECT c3.CMRC02 FROM TSTCOMMDAT.CMRCFIL c3 WHERE c3.CMRC01=ARE25) AS ChannelName, 
SUBSTRING(ARE75,17,10) AS ChnlAgentBussNo,
'' AS ChnlAgentName ,
ARE34 AS PolAgentId,
(SELECT c5.CMEM01 FROM TSTCOMMDAT.CMEMFIL c5 WHERE c5.CMEM00=ARE34) AS PolAgentName 
FROM TSTFLIBF.AREFIL a 
WHERE ARE05 = VARCHAR_FORMAT(CURRENT TIMESTAMP, 'YYYYMMDD')-19110001  AND ARE23 IN ('C','E','H','M','Q','R')  
AND ARE07 <> 0  
AND ARE25 NOT IN ('Y00008','I99055','I99050')
GROUP BY ARE05,ARE01,ARE23,ARE03,ARE04,ARE22,ARE25,ARE10,ARE34,ARE75,ARE24,ARE25
union
SELECT 
VARCHAR_FORMAT(TO_DATE(CHAR(APA17+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS PolDate, 
APA07 AS PolicyNo,
APA01 AS EndorseNo, 
SUBSTRING(APA07,7,2) AS InsType,
'批改' AS TYPE,  
(SELECT MAX(c.CMGT06) FROM TSTCOMMDAT.CMGTFIL c WHERE c.CMGT03=a2.APA07 AND c.CMGT05 = '2') AS InsuId,
(SELECT MAX(c2.CMGT04) FROM TSTCOMMDAT.CMGTFIL c2 WHERE c2.CMGT03=a2.APA07 AND c2.CMGT05 = '2') AS InsuName,
VARCHAR_FORMAT(TO_DATE(CHAR(APA56+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EffDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(APA56+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS StartPeriodDate, 
VARCHAR_FORMAT(TO_DATE(CHAR(APA57+19110000),'YYYYMMDD'),'YYYY-MM-DD') AS EndPeriodDate, 
sum(APA08*-1) AS TotalPrem,
APA20 AS ChannelId ,
(SELECT c3.CMRC02 FROM TSTCOMMDAT.CMRCFIL c3 WHERE c3.CMRC01=APA20) AS ChannelName, 
SUBSTRING(APA75,17,10) AS ChnlAgentBussNo,
'' AS ChnlAgentName ,
APA50 AS PolAgentId ,
(SELECT c5.CMEM01 FROM TSTCOMMDAT.CMEMFIL c5 WHERE c5.CMEM00=APA50) AS PolAgentName
FROM TSTFLIBF.APAFIL a2 WHERE APA17 = VARCHAR_FORMAT(CURRENT TIMESTAMP, 'YYYYMMDD')-19110001  AND APA06 IN ('2','3','4','D','E') AND APA18 IN ('C','E','H','M','Q','R') 
AND APA20 NOT IN ('Y00008','I99055','I99050')
GROUP BY APA17,APA01,APA18,APA07,APA56,APA20,APA09,APA50,APA57,APA75,APA74
ORDER BY PolDate,EndorseNo

