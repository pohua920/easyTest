<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="FirBatchSendmailDetail">
  <resultMap class="com.tlg.prpins.entity.FirBatchSendmailDetail" id="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 26 14:30:50 CST 2021.
    -->
    <result column="POLICYNO" jdbcType="VARCHAR" property="policyno" />
    <result column="BNO" jdbcType="VARCHAR" property="bno" />
    <result column="UNDERWRITEENDDATE" jdbcType="VARCHAR" property="underwriteenddate" />
    <result column="RISKCODE" jdbcType="VARCHAR" property="riskcode" />
    <result column="EMAILDATE" jdbcType="TIMESTAMP" property="emaildate" />
    <result column="BRNO" jdbcType="VARCHAR" property="brno" />
    <result column="SMSDATEDATE" jdbcType="TIMESTAMP" property="smsdatedate" />
    <result column="APPLICANTEMAIL" jdbcType="TIMESTAMP" property="applicantemail" />
    <result column="MOBILE" jdbcType="TIMESTAMP" property="mobile" />
  </resultMap>
  
  <!-- mantis：CAR0508，處理人員：BJ085，需求單編號：CAR0508 APS查詢電子保單發送結果(新增車險與旅平險) start-->
  <resultMap class="com.tlg.aps.vo.WriteForBatchSendmailVo" id="RiskcodeCountResultMap">
    <result column="RISKCODE" jdbcType="VARCHAR" property="riskcode" />
    <result column="COUNT" jdbcType="DECIMAL" property="count" />
  </resultMap>
  <!-- mantis：CAR0508，處理人員：BJ085，需求單編號：CAR0508 APS查詢電子保單發送結果(新增車險與旅平險) end-->
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 26 14:30:50 CST 2021.
    -->
    POLICYNO, BNO, UNDERWRITEENDDATE, RISKCODE, EMAILDATE, BRNO, SMSDATEDATE, APPLICANTEMAIL, MOBILE
  </sql>
  
  <select id="count" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(*) FROM <include refid="Utils.prpinsSchema"/>FIR_BATCH_SENDMAIL_DETAIL
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="policyno">
				POLICYNO = #policyno#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="underwriteenddate">
				UNDERWRITEENDDATE = #underwriteenddate#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="riskcode">
				RISKCODE = #riskcode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildate">
				EMAILDATE = #emaildate#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildateNotNull">
				(EMAILDATE is not null OR SMSDATEDATE is not null)
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildateNull">
				(EMAILDATE is null AND SMSDATEDATE is null)
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="startUnderwriteenddate">
				cast(UNDERWRITEENDDATE as integer)<![CDATA[>=]]> #startUnderwriteenddate#
		  	</isNotEmpty>
		  	<isNotEmpty prepend="AND" property="endUnderwriteenddate">
				cast(UNDERWRITEENDDATE as integer) <![CDATA[<=]]> #endUnderwriteenddate#
		  	</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="selectByParams" parameterClass="java.util.Map" resultMap="BaseResultMap">

    select * from <include refid="Utils.prpinsSchema"/>FIR_BATCH_SENDMAIL_DETAIL
    	<dynamic prepend="WHERE">
    		<isNotEmpty prepend="AND" property="policyno">
				POLICYNO = #policyno#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="underwriteenddate">
				UNDERWRITEENDDATE = #underwriteenddate#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="riskcode">
				RISKCODE = #riskcode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildate">
				EMAILDATE = #emaildate#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildateNotNull">
				EMAILDATE is not null
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildateNull">
				EMAILDATE is null
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="smsdatedateNull">
				SMSDATEDATE is null
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emailAndMobileNotNull">
				((EMAILDATE IS NULL AND APPLICANTEMAIL IS NOT NULL ) 
				OR (SMSDATEDATE IS NULL AND  (MOBILE IS NOT NULL AND SUBSTR(MOBILE, 0, 2) = '09' )))
			</isNotEmpty>
			<!-- mantis：CAR0508，處理人員：BJ085，需求單編號：CAR0508 APS查詢電子保單發送結果(新增車險與旅平險) start-->
			<isNotEmpty prepend="AND" property="emailAndMobileAllNull">
				((EMAILDATE IS NULL AND APPLICANTEMAIL IS NOT NULL ) 
				 OR (SMSDATEDATE IS NULL AND  (MOBILE IS NOT NULL AND SUBSTR(MOBILE, 0, 2) = '09' ))
				 OR (EMAILDATE IS NULL AND APPLICANTEMAIL IS NULL AND SMSDATEDATE IS NULL AND  MOBILE IS NULL))
			</isNotEmpty>
			<!-- mantis：CAR0508，處理人員：BJ085，需求單編號：CAR0508 APS查詢電子保單發送結果(新增車險與旅平險) end-->
			<isNotEmpty prepend="ORDER BY" property="orderBy">
				UNDERWRITEENDDATE DESC , POLICYNO
			</isNotEmpty>
		</dynamic>
  </select>
  
  <select id="select" parameterClass="java.util.Map" resultMap="BaseResultMap">
  	<include refid="Utils.sql1"/>
	 select 
    <include refid="FirBatchSendmailDetail.Base_Column_List" />
    from <include refid="Utils.prpinsSchema"/>FIR_BATCH_SENDMAIL_DETAIL
    <dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="policyno">
				POLICYNO = #policyno#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="underwriteenddate">
				UNDERWRITEENDDATE = #underwriteenddate#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="riskcode">
				RISKCODE = #riskcode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildate">
				EMAILDATE = #emaildate#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildateNotNull">
				(EMAILDATE is not null OR SMSDATEDATE is not null)
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="emaildateNull">
				(EMAILDATE is null AND SMSDATEDATE is null)
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="startUnderwriteenddate">
				cast(UNDERWRITEENDDATE as integer)<![CDATA[>=]]> #startUnderwriteenddate#
		  	</isNotEmpty>
		  	<isNotEmpty prepend="AND" property="endUnderwriteenddate">
				cast(UNDERWRITEENDDATE as integer) <![CDATA[<=]]> #endUnderwriteenddate#
		  	</isNotEmpty>
    </dynamic>
<!--     <include refid="Utils.sql2"/> -->
	ORDER BY  $sortBy$ $sortType$,$sortBy2$ ) A ))WHERE RN BETWEEN $startRow$ AND $endRow$
  </select>
  
  <select id="selectByPrimaryKey" parameterClass="com.tlg.prpins.entity.FirBatchSendmailDetail" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 26 14:30:50 CST 2021.
    -->
    select 
    <include refid="FirBatchSendmailDetail.Base_Column_List" />
    from FIR_BATCH_SENDMAIL_DETAIL
    where POLICYNO = #policyno:VARCHAR#
  </select>
  
  <!-- mantis：CAR0508，處理人員：BJ085，需求單編號：CAR0508 APS查詢電子保單發送結果(新增車險與旅平險) start-->
  <select id="selectRiskcodeForNoticeEmail" resultMap="RiskcodeCountResultMap" parameterClass="java.util.Map">
	SELECT RISKCODE,COUNT(1) AS COUNT FROM FIR_BATCH_SENDMAIL_DETAIL 
	WHERE ((EMAILDATE IS NULL AND APPLICANTEMAIL IS NOT NULL ) 
	OR (SMSDATEDATE IS NULL AND  (MOBILE IS NOT NULL AND SUBSTR(MOBILE, 0, 2) = '09' ))) 
	OR (EMAILDATE IS NULL AND APPLICANTEMAIL IS NULL AND SMSDATEDATE IS NULL AND  MOBILE IS NULL) 
	GROUP BY RISKCODE
  </select>
  <!-- mantis：CAR0508，處理人員：BJ085，需求單編號：CAR0508 APS查詢電子保單發送結果(新增車險與旅平險) end-->
  
  <delete id="delete" parameterClass="com.tlg.prpins.entity.FirBatchSendmailDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 26 14:30:50 CST 2021.
    -->
    delete from FIR_BATCH_SENDMAIL_DETAIL
    where POLICYNO = #policyno:VARCHAR#
  </delete>
  
  <insert id="insert" parameterClass="com.tlg.prpins.entity.FirBatchSendmailDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 26 14:30:50 CST 2021.
    -->
    insert into FIR_BATCH_SENDMAIL_DETAIL (POLICYNO, BNO, UNDERWRITEENDDATE, RISKCODE, 
      EMAILDATE, BRNO, SMSDATEDATE, APPLICANTEMAIL, MOBILE)
    values (#policyno:VARCHAR#, #bno:VARCHAR#, #underwriteenddate:VARCHAR#, #riskcode:VARCHAR#, 
      #emaildate:TIMESTAMP#, #brno:VARCHAR#, #smsdatedate:TIMESTAMP#, #applicantemail:VARCHAR#, #mobile:VARCHAR#)
  </insert>

  <update id="update" parameterClass="com.tlg.prpins.entity.FirBatchSendmailDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 26 14:30:50 CST 2021.
    -->
    update FIR_BATCH_SENDMAIL_DETAIL
    <dynamic prepend="set">
      <isNotNull prepend="," property="bno">
        BNO = #bno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="underwriteenddate">
        UNDERWRITEENDDATE = #underwriteenddate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="riskcode">
        RISKCODE = #riskcode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="emaildate">
        EMAILDATE = #emaildate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="brno">
        BRNO = #brno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="smsdatedate">
        SMSDATEDATE = #smsdatedate:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="applicantemail">
        APPLICANTEMAIL = #applicantemail:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="mobile">
        MOBILE = #mobile:VARCHAR#
      </isNotNull>
    </dynamic>
    where POLICYNO = #policyno:VARCHAR#
  </update>

</sqlMap>