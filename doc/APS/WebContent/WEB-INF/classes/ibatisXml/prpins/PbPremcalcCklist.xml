<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="PbPremcalcCklist">

	<resultMap id="BaseResultMap" class="com.tlg.prpins.entity.PbPremcalcCklist" >
	    <result column="OID" property="oid" jdbcType="DECIMAL" />
	    <result column="OID_FIR_PREMCALC_TMP" property="oidFirPremcalcTmp" jdbcType="DECIMAL" />
	    <result column="GROUP_NO" property="groupNo" jdbcType="VARCHAR" />
	    <result column="GITEM_NO" property="gitemNo" jdbcType="VARCHAR" />
	    <result column="CKLIST_NO" property="cklistNo" jdbcType="VARCHAR" />
	    <result column="CKLIST_RESULT" property="cklistResult" jdbcType="VARCHAR" />
	    <result column="CKLIST_SCORE" property="cklistScore" jdbcType="DECIMAL" />
	    <result column="CKLIST_Y" property="cklistY" jdbcType="DECIMAL" />
	    <result column="CKLIST_N" property="cklistN" jdbcType="DECIMAL" />
	    <result column="GROUP_LIMIT_UPPER" property="groupLimitUpper" jdbcType="DECIMAL" />
	    <result column="GROUP_LIMIT_LOWER" property="groupLimitLower" jdbcType="DECIMAL" />
	    <result column="MAX_LIMIT" property="maxLimit" jdbcType="DECIMAL" />
  	</resultMap>
  	
	<resultMap id="mapScore" class="java.util.HashMap">
		<result property="oid" column="OID"/>
		<result property="groupNo" column="GROUP_NO"/>
		<result property="gitemNo" column="GITEM_NO"/>
		<result property="cklistNo" column="CKLIST_NO"/>
		<result property="cklistResult" column="CKLIST_RESULT"/>
		<result property="cklistY" column="CKLIST_Y"/>
		<result property="cklistN" column="cklist_N"/>
		<result property="groupLimitUpper" column="GROUP_LIMIT_UPPER"/>
		<result property="groupLimitLower" column="GROUP_LIMIT_LOWER"/>
		<result property="cklistScore" column="CKLIST_SCORE"/>
	</resultMap>

	<select id="select" resultMap="BaseResultMap" parameterClass="java.util.Map">
		<include refid="Utils.sql1" />
		SELECT * FROM <include refid="Utils.prpinsSchema"/>PB_PREMCALC_CKLIST
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="oid">
				OID = #oid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="oidFirPremcalcTmp">
				OID_FIR_PREMCALC_TMP = #oidFirPremcalcTmp#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="groupNo">
				GROUP_NO = #groupNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="gitemNo">
				GITEM_NO = #gitemNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="cklistNo">
				CKLIST_NO = #cklistNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="cklistResult">
				CKLIST_RESULT = #cklistResult#
			</isNotEmpty>
		</dynamic>
		<include refid="Utils.sql2" />
	</select>

	<select id="selectByParams" resultMap="BaseResultMap" parameterClass="java.util.Map">
		SELECT * FROM <include refid="Utils.prpinsSchema"/>PB_PREMCALC_CKLIST
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="oid">
				OID = #oid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="oidFirPremcalcTmp">
				OID_FIR_PREMCALC_TMP = #oidFirPremcalcTmp#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="groupNo">
				GROUP_NO = #groupNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="gitemNo">
				GITEM_NO = #gitemNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="cklistNo">
				CKLIST_NO = #cklistNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="cklistResult">
				CKLIST_RESULT = #cklistResult#
			</isNotEmpty>
		</dynamic>
	</select>

 	
	<select id="count" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(*) FROM <include refid="Utils.prpinsSchema"/>PB_PREMCALC_CKLIST
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="oid">
				OID = #oid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="oidFirPremcalcTmp">
				OID_FIR_PREMCALC_TMP = #oidFirPremcalcTmp#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="groupNo">
				GROUP_NO = #groupNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="gitemNo">
				GITEM_NO = #gitemNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="cklistNo">
				CKLIST_NO = #cklistNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="cklistResult">
				CKLIST_RESULT = #cklistResult#
			</isNotEmpty>
		</dynamic>
	</select>
	

	
	<select id="selectByScore" resultMap="mapScore" parameterClass="java.util.Map">
		SELECT CL.OID,CL.GROUP_NO , CL.GITEM_NO, CL.CKLIST_NO, CL.CKLIST_RESULT, CS.CKLIST_Y, CS.CKLIST_N, CG.GROUP_LIMIT_UPPER, CG.GROUP_LIMIT_LOWER,
    			CASE WHEN CL.CKLIST_RESULT = '0' THEN 0
    			WHEN CL.CKLIST_RESULT = '1' THEN CS.CKLIST_Y
    			WHEN     CL.CKLIST_RESULT = '2' THEN CS.CKLIST_N
    			ELSE 0 END AS CKLIST_SCORE

		FROM <include refid="Utils.prpinsSchema"/>PB_PREMCALC_CKLIST CL
		INNER JOIN <include refid="Utils.prpinsSchema"/>PB_CKLIST_SCORE CS
		ON CL.GROUP_NO = CS.GROUP_NO 
		AND CL.GITEM_NO = CS.GITEM_NO
		AND CL.CKLIST_NO = CS.CKLIST_NO
		INNER JOIN <include refid="Utils.prpinsSchema"/>PB_CKLIST_GROUP CG
		ON CS.GROUP_NO = CG.GROUP_NO
		WHERE 1 = 1
		AND CL.OID_FIR_PREMCALC_TMP = #oidFtrPremcalcTmp#
		AND CS.VALID_DATE <![CDATA[<=]]> TO_DATE(#calcDate#,'YYYYMMDD') AND CS.INVALID_DATE <![CDATA[>=]]> TO_DATE(#calcDate#,'YYYYMMDD')
		AND CS.VALID_FALG = '1'
		AND CG.VALID_DATE <![CDATA[<=]]> TO_DATE(#calcDate#,'YYYYMMDD') AND CG.INVALID_DATE <![CDATA[>=]]> TO_DATE(#calcDate#,'YYYYMMDD')
		AND CG.VALID_FALG = '1'
	
	</select>
	
	<select id="selectByResultScore" resultClass="java.math.BigDecimal" parameterClass="java.util.Map">
		SELECT SUM(FCKL.SCORE) AS F_SCORE
		FROM (
		    SELECT CKL.GROUP_NO,
		    CASE
		        WHEN CKL.SCORE <![CDATA[>]]> CKL.GROUP_LIMIT_UPPER THEN CKL.GROUP_LIMIT_UPPER
		        WHEN CKL.SCORE <![CDATA[<]]> CKL.GROUP_LIMIT_LOWER THEN CKL.GROUP_LIMIT_LOWER
		        ELSE CKL.SCORE
		    END AS SCORE
		    FROM (
		        SELECT GROUP_NO, GROUP_LIMIT_UPPER, GROUP_LIMIT_LOWER, SUM(CKLIST_SCORE) AS SCORE
		        FROM PB_PREMCALC_CKLIST
		        WHERE OID_FIR_PREMCALC_TMP = #oidFtrPremcalcTmp#
		        GROUP BY GROUP_NO, GROUP_LIMIT_UPPER, GROUP_LIMIT_LOWER
		    ) CKL
		) FCKL
	</select>
	

	
	<insert id="insert" parameterClass="com.tlg.prpins.entity.PbPremcalcCklist" >
		<selectKey resultClass="java.math.BigDecimal" keyProperty="oid" >    
	       SELECT PB_PREMCALC_CKLIST_SEQ.NEXTVAL AS OID FROM DUAL    
	    </selectKey>

		INSERT INTO <include refid="Utils.prpinsSchema"/> PB_PREMCALC_CKLIST (OID, OID_FIR_PREMCALC_TMP, GROUP_NO, GITEM_NO, CKLIST_NO, CKLIST_RESULT,
      	CKLIST_SCORE, CKLIST_Y, CKLIST_N, GROUP_LIMIT_UPPER, GROUP_LIMIT_LOWER, MAX_LIMIT)
    	values (#oid:DECIMAL#, #oidFirPremcalcTmp:DECIMAL#, #groupNo:VARCHAR#, #gitemNo:VARCHAR#,
      	#cklistNo:VARCHAR#, #cklistResult:DECIMAL#, #cklistScore:DECIMAL#, #cklistY:DECIMAL#,
      	#cklistN:DECIMAL#, #groupLimitUpper:DECIMAL#, #groupLimitLower:DECIMAL#, #maxLimit:DECIMAL#)
	</insert>

	<delete id="delete" parameterClass="java.math.BigDecimal" >
		DELETE FROM <include refid="Utils.prpinsSchema"/>PB_PREMCALC_CKLIST WHERE OID = #oid:DECIMAL#
	</delete>
	
	<update id="update" parameterClass="com.tlg.prpins.entity.PbPremcalcCklist" >
		UPDATE <include refid="Utils.prpinsSchema"/>PB_PREMCALC_CKLIST
    	<dynamic prepend="set" >
      		<isNotNull prepend="," property="oidFirPremcalcTmp" >
        		OID_FIR_PREMCALC_TMP = #oidFirPremcalcTmp:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="," property="groupNo" >
        		GROUP_NO = #groupNo:VARCHAR#
      		</isNotNull>
      		<isNotNull prepend="," property="gitemNo" >
        		GITEM_NO = #gitemNo:VARCHAR#
      		</isNotNull>
      		<isNotNull prepend="," property="cklistNo" >
        		CKLIST_NO = #cklistNo:VARCHAR#
      		</isNotNull>
      		<isNotNull prepend="," property="cklistResult" >
        		CKLIST_RESULT = #cklistResult:VARCHAR#
      		</isNotNull>
      		<isNotNull prepend="," property="cklistScore" >
        		CKLIST_SCORE = #cklistScore:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="," property="cklistY" >
        		CKLIST_Y = #cklistY:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="," property="cklistN" >
        		CKLIST_N = #cklistN:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="," property="groupLimitUpper" >
        		GROUP_LIMIT_UPPER = #groupLimitUpper:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="," property="groupLimitLower" >
        		GROUP_LIMIT_LOWER = #groupLimitLower:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="," property="maxLimit" >
        		MAX_LIMIT = #maxLimit:DECIMAL#
      		</isNotNull>
		</dynamic>
		WHERE OID = #oid:DECIMAL#
	</update>

</sqlMap>